<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML//EN">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
<meta name="GENERATOR" content="GNU source-highlight 3.1.8
by Lorenzo Bettini
http://www.lorenzobettini.it
http://www.gnu.org/software/src-highlite">
<title>wsgi-admin.cpp</title>
</head>
<body bgcolor="white">
<pre><tt><i><font color="#9A1900">/**</font></i>
<i><font color="#9A1900"> * wsgi-admin, by Aaron Bloomfield, (c) 2014-2016</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * This is part of the SLP repository</font></i>
<i><font color="#9A1900"> * (</font></i><u><font color="#0000FF">https://github.com/aaronbloomfield/slp</font></u><i><font color="#9A1900">), and is released under a</font></i>
<i><font color="#9A1900"> * CC BY-SA license, like the rest of the repository.</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * This program will help manage the registration and de-registration</font></i>
<i><font color="#9A1900"> * of wsgi files.  It needs two Ubuntu pacakges to work: sqlite3 and</font></i>
<i><font color="#9A1900"> * libsqlite3-dev.</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * This program will take, as a command-line parameter, a wsgi file</font></i>
<i><font color="#9A1900"> * (such as Django's wsgi.py), and either add it to, or remove it</font></i>
<i><font color="#9A1900"> * from, a sqlite db.  The django.conf for apache is then</font></i>
<i><font color="#9A1900"> * re-generated, checking each existing wsgi file to make sure they</font></i>
<i><font color="#9A1900"> * are valid.</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * Full directions for how to use it can be found in the</font></i>
<i><font color="#9A1900"> * django-getting-started.md (and .html) files in the docs/ directory</font></i>
<i><font color="#9A1900"> * in the SLP repo.</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * Installation:</font></i>
<i><font color="#9A1900"> * - Compile with 'make', put it somewhere (such as /usr/local/bin)</font></i>
<i><font color="#9A1900"> * - You will need this to be in a group that can write to the two</font></i>
<i><font color="#9A1900"> *   conf files (in the directories declared in the #defines, below)</font></i>
<i><font color="#9A1900"> * - Run 'chmod 4755 wsgi-admin': this will set the set-uid bit when</font></i>
<i><font color="#9A1900"> *   the program runs.  This means the program will run as the user</font></i>
<i><font color="#9A1900"> *   who owns it, who (presumably) can edit those files.</font></i>
<i><font color="#9A1900"> * - the django.conf file needs to be writable by the user who owns</font></i>
<i><font color="#9A1900"> *   the compiled file</font></i>
<i><font color="#9A1900"> * - the DB file also needs to be writable by that user</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * Note that the app name is no longer used (it was previously used as</font></i>
<i><font color="#9A1900"> * part of the static directory), but has not been removed from this</font></i>
<i><font color="#9A1900"> * program yet.</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * The callback functions were adapted from</font></i>
<i><font color="#9A1900"> * </font></i><u><font color="#0000FF">http://www.sqlite.org/quickstart.html</font></u>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * Apache2 Configuration</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * Note that that multiple apache2 sites (such as http:// and</font></i>
<i><font color="#9A1900"> * https://) can not *both* define the WSGIDaemonProcess.  The site</font></i>
<i><font color="#9A1900"> * that is brought up first (likely http://) must define it.  For that</font></i>
<i><font color="#9A1900"> * reason, that command is enclosed in an </font></i><b><font color="#0000FF">&lt;IfModule&gt;</font></b><i><font color="#9A1900"> command.  To</font></i>
<i><font color="#9A1900"> * include it in the http:// site (likely 000-default.conf), have the</font></i>
<i><font color="#9A1900"> * following stanza:</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * </font></i><b><font color="#0000FF">&lt;IfDefine</font></b> <font color="#009900">NoDaemonProcess</font><b><font color="#0000FF">&gt;</font></b>
<i><font color="#9A1900"> *   UnDefine NoDaemonProcess</font></i>
<i><font color="#9A1900"> * </font></i><b><font color="#0000FF">&lt;/IfDefine&gt;</font></b>
<i><font color="#9A1900"> * Include django.conf</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * For the htts:// site (likely default-ssl.conf), have the following</font></i>
<i><font color="#9A1900"> * stanza:</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * Define NoDaemonProcess</font></i>
<i><font color="#9A1900"> * Include django.conf</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * DB schema:</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * id int auto_increment primary key</font></i>
<i><font color="#9A1900"> * uid int</font></i>
<i><font color="#9A1900"> * wsgi text</font></i>
<i><font color="#9A1900"> * valid boolean</font></i>
<i><font color="#9A1900"> * added datetime</font></i>
<i><font color="#9A1900"> * removed datetime</font></i>
<i><font color="#9A1900"> * app text</font></i>
<i><font color="#9A1900"> * rootdir boolean default 0</font></i>
<i><font color="#9A1900"> * staticdir text</font></i>
<i><font color="#9A1900"> * urluserid text</font></i>
<i><font color="#9A1900"> * morepath text</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * The line to create this in sqlite3:</font></i>
<i><font color="#9A1900"> * create table wsgi(id integer primary key asc, uid int, wsgi text, valid boolean, added datetime, removed datetime, app text, rootdir boolean default 0, staticdir text, urluserid text);</font></i>
<i><font color="#9A1900"> *</font></i>
<i><font color="#9A1900"> * Note that the urluserid allows for the URL to be different than the</font></i>
<i><font color="#9A1900"> * userid; if not set, it defaults to the userid.  While this program</font></i>
<i><font color="#9A1900"> * does pay attention to that value, it can not be set via this</font></i>
<i><font color="#9A1900"> * program, and must be manually set in the django.db.</font></i>
<i><font color="#9A1900"> */</font></i>

<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;iostream&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;sstream&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;stdlib.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;fstream&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;sys/types.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;sys/stat.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;unistd.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;sqlite3.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;stdio.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;string.h&gt;</font>
<b><font color="#000080">#include</font></b> <font color="#FF0000">&lt;pwd.h&gt;</font>

<b><font color="#0000FF">using</font></b> <b><font color="#0000FF">namespace</font></b> std<font color="#990000">;</font>

<i><font color="#9A1900">// constants to change as per your system configuration</font></i>
<b><font color="#000080">#define</font></b> DJANGO_CONF_FILE <font color="#FF0000">"/etc/apache2/django.conf"</font>
<b><font color="#000080">#define</font></b> APACHE2_RELOAD_CMD <font color="#FF0000">"/usr/local/bin/reload-apache2"</font>
<b><font color="#000080">#define</font></b> URL_PREFIX <font color="#FF0000">"/django"</font>
<b><font color="#000080">#define</font></b> DATABASE_FILE <font color="#FF0000">"/etc/apache2/django.db"</font>
<b><font color="#000080">#define</font></b> DEFAULT_APP_NAME <font color="#FF0000">"polls"</font>

<i><font color="#9A1900">// some global variables</font></i>
<font color="#008080">stringstream</font> wsgifile<font color="#990000">,</font> query<font color="#990000">;</font>
<font color="#009900">int</font> count <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> find_uid <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> reg_root <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> remove_id <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">,</font> force_uid <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#008080">string</font> find_filename <font color="#990000">=</font> <font color="#FF0000">""</font><font color="#990000">,</font> appname <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font>DEFAULT_APP_NAME<font color="#990000">),</font> wsgi_file_name<font color="#990000">,</font> staticdir<font color="#990000">,</font> morepath<font color="#990000">;</font>
<font color="#009900">bool</font> check_file <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">,</font> compact_list <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">,</font> show_all <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>

<i><font color="#9A1900">// for when they invoke it incorrectly...</font></i>
<font color="#009900">void</font> <b><font color="#000000">printUsage</font></b><font color="#990000">(</font><font color="#009900">char</font> <font color="#990000">*</font>argv0<font color="#990000">,</font> <font color="#009900">bool</font> doexit <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">)</font> <font color="#FF0000">{</font>
    cerr <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"Usage:  "</font> <font color="#990000">&lt;&lt;</font> argv0 <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" -register -file &lt;wsgi_file&gt; [-app &lt;app_name&gt;] [-root] [-path &lt;virtual_env_path&gt;]</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
         <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\t</font><font color="#FF0000">"</font> <font color="#990000">&lt;&lt;</font> argv0 <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" -remove -id &lt;num&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
         <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\t</font><font color="#FF0000">"</font> <font color="#990000">&lt;&lt;</font> argv0 <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" -list [-compact]</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
         <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\t</font><font color="#FF0000">"</font> <font color="#990000">&lt;&lt;</font> argv0 <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" -regenrate"</font> <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> doexit <font color="#990000">)</font>
        <b><font color="#000000">exit</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// prints an error message with the query, deallocates that error message, and exits</font></i>
<font color="#009900">void</font> <b><font color="#000000">sqlite3_die</font></b><font color="#990000">(</font><font color="#009900">char</font> <font color="#990000">*</font>errmsg<font color="#990000">,</font> <font color="#008080">string</font> query<font color="#990000">)</font> <font color="#FF0000">{</font>
    cerr <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"SQL error: "</font> <font color="#990000">&lt;&lt;</font> errmsg <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" on query: "</font> <font color="#990000">&lt;&lt;</font> query <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
    <b><font color="#000000">sqlite3_free</font></b><font color="#990000">(</font>errmsg<font color="#990000">);</font>
    <b><font color="#000000">exit</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// prints the error message and exits</font></i>
<font color="#009900">void</font> <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#008080">string</font> s<font color="#990000">)</font> <font color="#FF0000">{</font>
    cerr <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"Error: "</font> <font color="#990000">&lt;&lt;</font> s <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
    <b><font color="#000000">exit</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// finds who owns a file</font></i>
<font color="#009900">int</font> <b><font color="#000000">get_UID_for_file</font></b> <font color="#990000">(</font><b><font color="#0000FF">const</font></b> <font color="#009900">char</font><font color="#990000">*</font> filename<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">struct</font></b> <font color="#008080">stat</font> buf<font color="#990000">;</font>
    <font color="#009900">int</font> uid <font color="#990000">=</font> <b><font color="#000000">stat</font></b><font color="#990000">(</font>filename<font color="#990000">,&amp;</font>buf<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> buf<font color="#990000">.</font>st_uid<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// maps a UID to a Unix user name</font></i>
<font color="#009900">char</font><font color="#990000">*</font> <b><font color="#000000">get_userid_by_uid</font></b> <font color="#990000">(</font><font color="#009900">int</font> uid<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">struct</font></b> <font color="#008080">passwd</font> <font color="#990000">*</font>p <font color="#990000">=</font> <b><font color="#000000">getpwuid</font></b><font color="#990000">(</font>uid<font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> p <font color="#990000">==</font> NULL <font color="#990000">)</font> <font color="#FF0000">{</font>
        cerr <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"Unknown user with uid "</font> <font color="#990000">&lt;&lt;</font> uid <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
        <b><font color="#000000">exit</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font>
    <font color="#FF0000">}</font>
    <b><font color="#0000FF">return</font></b> p<font color="#990000">-&gt;</font>pw_name<font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// checks if a file exists; this function adapted from</font></i>
<i><font color="#9A1900">//http://stackoverflow.com/questions/12774207/fastest-way-to-check-if-a-file-exist-using-standard-c-c11-c</font></i>
<b><font color="#0000FF">inline</font></b> <font color="#009900">bool</font> <b><font color="#000000">file_exists</font></b> <font color="#990000">(</font><b><font color="#0000FF">const</font></b> std<font color="#990000">::</font>string<font color="#990000">&amp;</font> name<font color="#990000">)</font> <font color="#FF0000">{</font>
    <font color="#008080">ifstream</font> <b><font color="#000000">f</font></b><font color="#990000">(</font>name<font color="#990000">.</font><b><font color="#000000">c_str</font></b><font color="#990000">());</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font>f<font color="#990000">.</font><b><font color="#000000">good</font></b><font color="#990000">())</font> <font color="#FF0000">{</font>
        f<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">();</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
        f<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">();</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
    <font color="#FF0000">}</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// checks if the passed file is a valid WSGI file (really if it's a Python script)</font></i>
<font color="#009900">bool</font> <b><font color="#000000">is_valid_wsgi_file</font></b><font color="#990000">(</font><b><font color="#0000FF">const</font></b> <font color="#009900">char</font> <font color="#990000">*</font>filename<font color="#990000">)</font> <font color="#FF0000">{</font>
    <i><font color="#9A1900">// get the file type</font></i>
    <font color="#008080">stringstream</font> cmd<font color="#990000">;</font>
    cmd <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"/usr/bin/file "</font> <font color="#990000">&lt;&lt;</font> filename<font color="#990000">;</font>
    <font color="#008080">FILE</font> <font color="#990000">*</font>fp <font color="#990000">=</font> <b><font color="#000000">popen</font></b><font color="#990000">(</font>cmd<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font><font color="#FF0000">"r"</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> fp <font color="#990000">==</font> NULL <font color="#990000">)</font>
        <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Failed to run 'file' command"</font><font color="#990000">);</font>
    <font color="#009900">char</font> result<font color="#990000">[</font><font color="#993399">1024</font><font color="#990000">];</font>
    <b><font color="#000000">fgets</font></b><font color="#990000">(</font>result<font color="#990000">,</font> <b><font color="#0000FF">sizeof</font></b><font color="#990000">(</font>result<font color="#990000">)-</font><font color="#993399">1</font><font color="#990000">,</font> fp<font color="#990000">);</font>
    <b><font color="#000000">pclose</font></b><font color="#990000">(</font>fp<font color="#990000">);</font>
    <i><font color="#9A1900">// check that the output was correct</font></i>
    <font color="#008080">string</font> <b><font color="#000000">obtained</font></b><font color="#990000">(</font>result<font color="#990000">);</font>
    <font color="#008080">stringstream</font> expected<font color="#990000">;</font>
    expected <font color="#990000">&lt;&lt;</font> filename <font color="#990000">&lt;&lt;</font> <font color="#FF0000">": Python script, ASCII text executable</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> obtained <font color="#990000">==</font> expected<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">()</font> <font color="#990000">)</font>
        <b><font color="#0000FF">return</font></b> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
    expected<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
    expected <font color="#990000">&lt;&lt;</font> filename <font color="#990000">&lt;&lt;</font> <font color="#FF0000">": Python script, ASCII text executable, with CRLF line terminators</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b> <font color="#990000">(</font> obtained <font color="#990000">==</font> expected<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">()</font> <font color="#990000">);</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// how to handle the data returned when displaying the list of the DB entries</font></i>
<b><font color="#0000FF">static</font></b> <font color="#009900">int</font> <b><font color="#000000">list_callback</font></b><font color="#990000">(</font><font color="#009900">void</font> <font color="#990000">*</font>NotUsed<font color="#990000">,</font> <font color="#009900">int</font> argc<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>argv<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>azColName<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">for</font></b><font color="#990000">(</font> <font color="#009900">int</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> argc<font color="#990000">;</font> i<font color="#990000">++</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> compact_list <font color="#990000">)</font> <font color="#FF0000">{</font>
            cout <font color="#990000">&lt;&lt;</font> azColName<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" = "</font> <font color="#990000">&lt;&lt;</font> <font color="#990000">(</font>argv<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">?</font> argv<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">:</font> <font color="#FF0000">"NULL"</font><font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"; "</font><font color="#990000">;</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <b><font color="#000000">strcmp</font></b><font color="#990000">(</font>azColName<font color="#990000">[</font>i<font color="#990000">],</font><font color="#FF0000">"id"</font><font color="#990000">)</font> <font color="#990000">)</font>
                cout <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\t</font><font color="#FF0000">"</font><font color="#990000">;</font>
            cout <font color="#990000">&lt;&lt;</font> azColName<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" = "</font> <font color="#990000">&lt;&lt;</font> <font color="#990000">(</font>argv<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">?</font> argv<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">:</font> <font color="#FF0000">"NULL"</font><font color="#990000">);</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!</font><b><font color="#000000">strcmp</font></b><font color="#990000">(</font>azColName<font color="#990000">[</font>i<font color="#990000">],</font><font color="#FF0000">"uid"</font><font color="#990000">)</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
                <font color="#009900">int</font> uid<font color="#990000">;</font>
                <b><font color="#000000">sscanf</font></b><font color="#990000">(</font>argv<font color="#990000">[</font>i<font color="#990000">],</font><font color="#FF0000">"%d"</font><font color="#990000">,&amp;</font>uid<font color="#990000">);</font>
                cout <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" ("</font> <font color="#990000">&lt;&lt;</font> <b><font color="#000000">get_userid_by_uid</font></b><font color="#990000">(</font>uid<font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">")"</font><font color="#990000">;</font>
            <font color="#FF0000">}</font>
            cout <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
        <font color="#FF0000">}</font>
    <font color="#FF0000">}</font>
    cout <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// gets the count(*) field and saves it in a global variable</font></i>
<b><font color="#0000FF">static</font></b> <font color="#009900">int</font> <b><font color="#000000">count_callback</font></b><font color="#990000">(</font><font color="#009900">void</font> <font color="#990000">*</font>NotUsed<font color="#990000">,</font> <font color="#009900">int</font> argc<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>argv<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>azColName<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> argc <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"count_callback returned multiple columns!"</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <b><font color="#000000">strcmp</font></b><font color="#990000">(</font>azColName<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font><font color="#FF0000">"count(*)"</font><font color="#990000">)</font> <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"count_callback not provided a count(*) column"</font><font color="#990000">);</font>
    <b><font color="#000000">sscanf</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">],</font><font color="#FF0000">"%d"</font><font color="#990000">,&amp;</font>count<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// this callback allows searching for the 'wsgi' and 'uid' fields in the DB</font></i>
<b><font color="#0000FF">static</font></b> <font color="#009900">int</font> <b><font color="#000000">find_callback</font></b><font color="#990000">(</font><font color="#009900">void</font> <font color="#990000">*</font>NotUsed<font color="#990000">,</font> <font color="#009900">int</font> argc<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>argv<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>azColName<font color="#990000">)</font> <font color="#FF0000">{</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> argc <font color="#990000">&lt;</font> <font color="#993399">2</font> <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"invalid result set to find_callback (1)"</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <b><font color="#000000">strcmp</font></b><font color="#990000">(</font>azColName<font color="#990000">[</font><font color="#993399">2</font><font color="#990000">],</font><font color="#FF0000">"wsgi"</font><font color="#990000">)</font> <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"invalid result set to find_callback (2)"</font><font color="#990000">);</font>
    find_filename <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">2</font><font color="#990000">]);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <b><font color="#000000">strcmp</font></b><font color="#990000">(</font>azColName<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">],</font><font color="#FF0000">"uid"</font><font color="#990000">)</font> <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"invalid result set to find_callback (3)"</font><font color="#990000">);</font>
    <b><font color="#000000">sscanf</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">],</font><font color="#FF0000">"%d"</font><font color="#990000">,&amp;</font>find_uid<font color="#990000">);</font>
    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// this regenerates the django.conf files</font></i>
<b><font color="#0000FF">static</font></b> <font color="#009900">int</font> <b><font color="#000000">regenerate_callback</font></b><font color="#990000">(</font><font color="#009900">void</font> <font color="#990000">*</font>NotUsed<font color="#990000">,</font> <font color="#009900">int</font> argc<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>argv<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>azColName<font color="#990000">)</font> <font color="#FF0000">{</font>
    <font color="#009900">int</font> uid<font color="#990000">,</font> rootdir<font color="#990000">;</font>
    <b><font color="#000000">sscanf</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">1</font><font color="#990000">],</font><font color="#FF0000">"%d"</font><font color="#990000">,&amp;</font>uid<font color="#990000">);</font>
    <font color="#009900">char</font> <font color="#990000">*</font>filename <font color="#990000">=</font> argv<font color="#990000">[</font><font color="#993399">2</font><font color="#990000">];</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!</font><b><font color="#000000">file_exists</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">2</font><font color="#990000">])</font> <font color="#990000">)</font>
        <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!</font><b><font color="#000000">is_valid_wsgi_file</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">2</font><font color="#990000">])</font> <font color="#990000">)</font>
        <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
    <b><font color="#000000">sscanf</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">7</font><font color="#990000">],</font> <font color="#FF0000">"%d"</font><font color="#990000">,</font> <font color="#990000">&amp;</font>rootdir<font color="#990000">);</font>
    <font color="#008080">string</font> <b><font color="#000000">userid</font></b><font color="#990000">(</font><b><font color="#000000">get_userid_by_uid</font></b><font color="#990000">(</font>uid<font color="#990000">));</font> <i><font color="#9A1900">// userid of who registered this</font></i>
    <font color="#008080">string</font> <b><font color="#000000">fullpath</font></b><font color="#990000">(</font><b><font color="#000000">realpath</font></b><font color="#990000">(</font>filename<font color="#990000">,</font>NULL<font color="#990000">));</font> <i><font color="#9A1900">// full path of the wsgi.py file</font></i>
    <font color="#009900">int</font> pos <font color="#990000">=</font> fullpath<font color="#990000">.</font><b><font color="#000000">rfind</font></b><font color="#990000">(</font><font color="#FF0000">"/"</font><font color="#990000">);</font>
    <font color="#008080">string</font> up1 <font color="#990000">=</font> fullpath<font color="#990000">.</font><b><font color="#000000">substr</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font>pos<font color="#990000">);</font> <i><font color="#9A1900">// the directory that the wsgi.py file is in</font></i>
    <font color="#008080">string</font> basename <font color="#990000">=</font> fullpath<font color="#990000">.</font><b><font color="#000000">substr</font></b><font color="#990000">(</font>pos<font color="#990000">+</font><font color="#993399">1</font><font color="#990000">);</font> <i><font color="#9A1900">// typically 'wsgi.py', the actual file name</font></i>
    <font color="#008080">string</font> <b><font color="#000000">app</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">6</font><font color="#990000">]);</font> <i><font color="#9A1900">// the app name</font></i>
    pos <font color="#990000">=</font> up1<font color="#990000">.</font><b><font color="#000000">rfind</font></b><font color="#990000">(</font><font color="#FF0000">"/"</font><font color="#990000">);</font>
    <font color="#008080">string</font> up2 <font color="#990000">=</font> up1<font color="#990000">.</font><b><font color="#000000">substr</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">,</font>pos<font color="#990000">);</font> <i><font color="#9A1900">// the directory *above* the wsgi.py file</font></i>
    <font color="#008080">string</font> staticdir<font color="#990000">;</font> <i><font color="#9A1900">// the static directory, which is determined below</font></i>
    <font color="#008080">stringstream</font> foo<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">8</font><font color="#990000">]</font> <font color="#990000">==</font> NULL<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font><b><font color="#000000">strlen</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">8</font><font color="#990000">])</font> <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
        <i><font color="#9A1900">// the assumption is that there is a static/ directory in the main project directory...</font></i>
        foo <font color="#990000">&lt;&lt;</font> up2 <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"/static"</font><font color="#990000">;</font>
        staticdir <font color="#990000">=</font> foo<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">();</font>
    <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b>
        <i><font color="#9A1900">/// ... unless they have specified otherwise</font></i>
        staticdir <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">8</font><font color="#990000">]);</font>
    <font color="#008080">string</font> urluserid<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">9</font><font color="#990000">]</font> <font color="#990000">==</font> NULL<font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font><b><font color="#000000">strlen</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">9</font><font color="#990000">])</font> <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">)</font>
        <i><font color="#9A1900">// the assumption is that url userid is the same as their userid</font></i>
        urluserid <font color="#990000">=</font> userid<font color="#990000">;</font>
    <b><font color="#0000FF">else</font></b>
        <i><font color="#9A1900">/// ... unless they have specified otherwise</font></i>
        urluserid <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">9</font><font color="#990000">]);</font>
    <font color="#008080">string</font> path <font color="#990000">=</font> up2<font color="#990000">;</font>

    wsgifile <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"Alias "</font> <font color="#990000">&lt;&lt;</font> <font color="#990000">(</font>rootdir<font color="#990000">?</font><font color="#FF0000">""</font><font color="#990000">:</font>URL_PREFIX<font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"/"</font> <font color="#990000">&lt;&lt;</font> urluserid <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"/static "</font> <font color="#990000">&lt;&lt;</font> staticdir <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&lt;Directory "</font> <font color="#990000">&lt;&lt;</font> staticdir <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"  Require all granted</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&lt;/Directory&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">;</font>
    wsgifile <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"WSGIScriptAlias "</font> <font color="#990000">&lt;&lt;</font> <font color="#990000">(</font>rootdir<font color="#990000">?</font><font color="#FF0000">""</font><font color="#990000">:</font>URL_PREFIX<font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"/"</font> <font color="#990000">&lt;&lt;</font> urluserid <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" "</font> <font color="#990000">&lt;&lt;</font> fullpath <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">;</font>
    wsgifile <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&lt;IfDefine !NoDaemonProcess&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
	     <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"  WSGIDaemonProcess "</font> <font color="#990000">&lt;&lt;</font> urluserid <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" user="</font> <font color="#990000">&lt;&lt;</font> urluserid <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" python-path="</font> <font color="#990000">&lt;&lt;</font> path<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">10</font><font color="#990000">]</font> <font color="#990000">!=</font> NULL<font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font><b><font color="#000000">strlen</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">10</font><font color="#990000">])</font> <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">)</font>
      wsgifile <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" python-home="</font> <font color="#990000">&lt;&lt;</font> argv<font color="#990000">[</font><font color="#993399">10</font><font color="#990000">];</font>
    wsgifile <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">&lt;/IfDefine&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font><font color="#990000">;</font>
    wsgifile <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&lt;Location "</font> <font color="#990000">&lt;&lt;</font> <font color="#990000">(</font>rootdir<font color="#990000">?</font><font color="#FF0000">""</font><font color="#990000">:</font>URL_PREFIX<font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"/"</font> <font color="#990000">&lt;&lt;</font> urluserid <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"  WSGIProcessGroup "</font> <font color="#990000">&lt;&lt;</font> urluserid <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&lt;/Location&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&lt;Directory "</font> <font color="#990000">&lt;&lt;</font> up1 <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"  &lt;Files "</font> <font color="#990000">&lt;&lt;</font> basename <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"    Require all granted</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"  &lt;/Files&gt;</font><font color="#CC33CC">\n</font><font color="#FF0000">"</font>
        <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"&lt;/Directory&gt;</font><font color="#CC33CC">\n\n</font><font color="#FF0000">"</font><font color="#990000">;</font>
    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>

<i><font color="#9A1900">// what does the main() say?</font></i>
<font color="#009900">int</font> <b><font color="#000000">main</font></b><font color="#990000">(</font><font color="#009900">int</font> argc<font color="#990000">,</font> <font color="#009900">char</font> <font color="#990000">**</font>argv<font color="#990000">)</font> <font color="#FF0000">{</font>

    <font color="#009900">int</font> uid <font color="#990000">=</font> <b><font color="#000000">getuid</font></b><font color="#990000">();</font> <i><font color="#9A1900">// get user's uid</font></i>
    <b><font color="#000000">setuid</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font> <i><font color="#9A1900">// ensure we are running as root (requires SUID bit set as well)</font></i>

    <b><font color="#0000FF">enum</font></b> <font color="#FF0000">{</font> MODE_NONE<font color="#990000">,</font> MODE_REGISTER<font color="#990000">,</font> MODE_REMOVE<font color="#990000">,</font> MODE_REGENERATE<font color="#990000">,</font> MODE_LIST <font color="#FF0000">}</font> mode <font color="#990000">=</font> MODE_NONE<font color="#990000">;</font>
    <font color="#009900">char</font> <font color="#990000">*</font>filename <font color="#990000">=</font> NULL<font color="#990000">;</font>
    <font color="#009900">int</font> ret<font color="#990000">;</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> argc <font color="#990000">==</font> <font color="#993399">1</font> <font color="#990000">)</font>
        <b><font color="#000000">printUsage</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]);</font>

    <i><font color="#9A1900">// parse command line parameters, get wsgi file and mode</font></i>
    <b><font color="#0000FF">for</font></b> <font color="#990000">(</font> <font color="#009900">int</font> i <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> argc<font color="#990000">;</font> i<font color="#990000">++</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
        <font color="#008080">string</font> <b><font color="#000000">param</font></b><font color="#990000">(</font>argv<font color="#990000">[</font>i<font color="#990000">]);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-help"</font> <font color="#990000">)</font>
            <b><font color="#000000">printUsage</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]);</font>
        <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-register"</font> <font color="#990000">)</font>
            mode <font color="#990000">=</font> MODE_REGISTER<font color="#990000">;</font>
        <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-remove"</font> <font color="#990000">)</font>
            mode <font color="#990000">=</font> MODE_REMOVE<font color="#990000">;</font>
        <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-regenerate"</font> <font color="#990000">)</font>
            mode <font color="#990000">=</font> MODE_REGENERATE<font color="#990000">;</font>
        <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-compact"</font> <font color="#990000">)</font>
            compact_list <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
        <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-root"</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <i><font color="#9A1900">//if ( (uid != 0) &amp;&amp; (uid != 1000) )</font></i>
            <i><font color="#9A1900">//die ("You are not allowed to use the -root flag");</font></i>
            reg_root <font color="#990000">=</font> <font color="#993399">1</font><font color="#990000">;</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-list"</font> <font color="#990000">)</font>
            mode <font color="#990000">=</font> MODE_LIST<font color="#990000">;</font>
        <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-all"</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">1000</font><font color="#990000">)</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"You are not allowed to use the -all flag"</font><font color="#990000">);</font>
            show_all <font color="#990000">=</font> <b><font color="#0000FF">true</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-staticdir"</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> argc <font color="#990000">==</font> i<font color="#990000">+</font><font color="#993399">1</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Must supply a directory name to -staticdir"</font><font color="#990000">);</font>
            staticdir <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font>argv<font color="#990000">[++</font>i<font color="#990000">]);</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>param <font color="#990000">==</font> <font color="#FF0000">"-path"</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>param <font color="#990000">==</font> <font color="#FF0000">"-morepath"</font><font color="#990000">)</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> argc <font color="#990000">==</font> i<font color="#990000">+</font><font color="#993399">1</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Must supply a directory name to -path or -morepath"</font><font color="#990000">);</font>
            morepath <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font>argv<font color="#990000">[++</font>i<font color="#990000">]);</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-nocheck"</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">1000</font><font color="#990000">)</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"You are not allowed to use the -nocheck flag"</font><font color="#990000">);</font>
            check_file <font color="#990000">=</font> <b><font color="#0000FF">false</font></b><font color="#990000">;</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-app"</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> argc <font color="#990000">==</font> i<font color="#990000">+</font><font color="#993399">1</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Must supply a app name to -app"</font><font color="#990000">);</font>
            appname <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font>argv<font color="#990000">[++</font>i<font color="#990000">]);</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-uid"</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">1000</font><font color="#990000">)</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"You are not allowed to use the -uid flag"</font><font color="#990000">);</font>
            <font color="#009900">int</font> ret <font color="#990000">=</font> <b><font color="#000000">sscanf</font></b><font color="#990000">(</font>argv<font color="#990000">[++</font>i<font color="#990000">],</font> <font color="#FF0000">"%d"</font><font color="#990000">,</font> <font color="#990000">&amp;</font>force_uid<font color="#990000">);</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Invalid integer format to -uid"</font><font color="#990000">);</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-id"</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> argc <font color="#990000">==</font> i<font color="#990000">+</font><font color="#993399">1</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Must supply a numerical id to -id"</font><font color="#990000">);</font>
            <font color="#009900">int</font> ret <font color="#990000">=</font> <b><font color="#000000">sscanf</font></b><font color="#990000">(</font>argv<font color="#990000">[++</font>i<font color="#990000">],</font> <font color="#FF0000">"%d"</font><font color="#990000">,</font> <font color="#990000">&amp;</font>remove_id<font color="#990000">);</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> <font color="#993399">1</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Invalid integer format to -id"</font><font color="#990000">);</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b> <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> param <font color="#990000">==</font> <font color="#FF0000">"-file"</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> argc <font color="#990000">==</font> i<font color="#990000">+</font><font color="#993399">1</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Must supply a file name to -file"</font><font color="#990000">);</font>
            wsgi_file_name <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font>argv<font color="#990000">[++</font>i<font color="#990000">]);</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!</font><b><font color="#000000">file_exists</font></b><font color="#990000">(</font>wsgi_file_name<font color="#990000">)</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"File does not exist!"</font><font color="#990000">);</font>
        <font color="#FF0000">}</font> <b><font color="#0000FF">else</font></b>
            <b><font color="#000000">printUsage</font></b><font color="#990000">(</font>argv<font color="#990000">[</font><font color="#993399">0</font><font color="#990000">]);</font>
    <font color="#FF0000">}</font>

    <i><font color="#9A1900">// check the parameters</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>wsgi_file_name <font color="#990000">==</font> <font color="#FF0000">""</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>mode <font color="#990000">==</font> MODE_REGISTER<font color="#990000">)</font> <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"Must supply a file name with -register"</font><font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>remove_id <font color="#990000">==</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>mode <font color="#990000">==</font> MODE_REMOVE<font color="#990000">)</font> <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"Must supply a id (via -id) with -remove"</font><font color="#990000">);</font>

    <i><font color="#9A1900">// open the DB</font></i>
    <font color="#008080">sqlite3</font> <font color="#990000">*</font>db<font color="#990000">;</font>
    <font color="#009900">char</font> <font color="#990000">*</font>errmsg <font color="#990000">=</font> NULL<font color="#990000">;</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!</font><b><font color="#000000">file_exists</font></b><font color="#990000">(</font>DATABASE_FILE<font color="#990000">)</font> <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"database file does not exist"</font><font color="#990000">);</font>
    ret <font color="#990000">=</font> <b><font color="#000000">sqlite3_open</font></b><font color="#990000">(</font>DATABASE_FILE<font color="#990000">,&amp;</font>db<font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> SQLITE_OK <font color="#990000">)</font>
        <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"Can't open the DB"</font><font color="#990000">);</font>

    <i><font color="#9A1900">// register a new entry</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> mode <font color="#990000">==</font> MODE_REGISTER <font color="#990000">)</font> <font color="#FF0000">{</font>

        <i><font color="#9A1900">// sanity check the file name</font></i>
        <b><font color="#0000FF">for</font></b> <font color="#990000">(</font> <font color="#009900">int</font> i <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font> i <font color="#990000">&lt;</font> wsgi_file_name<font color="#990000">.</font><b><font color="#000000">length</font></b><font color="#990000">();</font> i<font color="#990000">++</font> <font color="#990000">)</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>wsgi_file_name<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'</font><font color="#CC33CC">\\</font><font color="#FF0000">'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>wsgi_file_name<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'"'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>wsgi_file_name<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">'</font><font color="#CC33CC">\'</font><font color="#FF0000">'</font><font color="#990000">)</font> <font color="#990000">||</font> <font color="#990000">(</font>wsgi_file_name<font color="#990000">[</font>i<font color="#990000">]</font> <font color="#990000">==</font> <font color="#FF0000">';'</font><font color="#990000">)</font> <font color="#990000">)</font>
                <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"Try choosing a file name that does *not* lend itself to SQL injection attacks"</font><font color="#990000">);</font>

        <i><font color="#9A1900">// does the file exist?</font></i>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!</font><b><font color="#000000">file_exists</font></b><font color="#990000">(</font>wsgi_file_name<font color="#990000">)</font> <font color="#990000">)</font> <font color="#FF0000">{</font>
            cerr <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"File '"</font> <font color="#990000">&lt;&lt;</font> wsgi_file_name <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"' does not exist!"</font> <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
            <b><font color="#000000">exit</font></b><font color="#990000">(</font><font color="#993399">0</font><font color="#990000">);</font>
        <font color="#FF0000">}</font>

        <i><font color="#9A1900">// is it a Python file?</font></i>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> check_file <font color="#990000">&amp;&amp;</font> <font color="#990000">!</font><b><font color="#000000">is_valid_wsgi_file</font></b><font color="#990000">(</font>wsgi_file_name<font color="#990000">.</font><b><font color="#000000">c_str</font></b><font color="#990000">())</font> <font color="#990000">)</font>
            <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"Not a valid WSGI file"</font><font color="#990000">);</font>

        <i><font color="#9A1900">// is it owned by the user executing this script?</font></i>
        <font color="#009900">int</font> fuid <font color="#990000">=</font> <b><font color="#000000">get_UID_for_file</font></b> <font color="#990000">(</font>wsgi_file_name<font color="#990000">.</font><b><font color="#000000">c_str</font></b><font color="#990000">());</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> force_uid <font color="#990000">!=</font> <font color="#993399">0</font> <font color="#990000">)</font>
            fuid <font color="#990000">=</font> force_uid<font color="#990000">;</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">1000</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>fuid <font color="#990000">!=</font> uid<font color="#990000">)</font> <font color="#990000">)</font>
            <b><font color="#000000">die</font></b> <font color="#990000">(</font><font color="#FF0000">"You cannot register a file that you do not own"</font><font color="#990000">);</font>

        <i><font color="#9A1900">// check for duplicate entries of that file</font></i>
        query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
        query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"select count(*) from wsgi where wsgi=</font><font color="#CC33CC">\"</font><font color="#FF0000">"</font>
              <font color="#990000">&lt;&lt;</font> <b><font color="#000000">realpath</font></b><font color="#990000">(</font>wsgi_file_name<font color="#990000">.</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font>NULL<font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\"</font><font color="#FF0000"> and valid=1"</font><font color="#990000">;</font>
        count <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
        ret <font color="#990000">=</font> <b><font color="#000000">sqlite3_exec</font></b><font color="#990000">(</font>db<font color="#990000">,</font> query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font> count_callback<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">&amp;</font>errmsg<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> SQLITE_OK <font color="#990000">)</font>
            <b><font color="#000000">sqlite3_die</font></b><font color="#990000">(</font>errmsg<font color="#990000">,</font>query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">());</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> count <font color="#990000">&gt;</font> <font color="#993399">0</font> <font color="#990000">)</font>
            <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"This wsgi file has already been registered"</font><font color="#990000">);</font>

        <i><font color="#9A1900">// check for existing entries by this UID</font></i>
        query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
        query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"select count(*) from wsgi where uid="</font> <font color="#990000">&lt;&lt;</font> uid <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" and valid=1"</font><font color="#990000">;</font>
        count <font color="#990000">=</font> <font color="#993399">0</font><font color="#990000">;</font>
        ret <font color="#990000">=</font> <b><font color="#000000">sqlite3_exec</font></b><font color="#990000">(</font>db<font color="#990000">,</font> query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font> count_callback<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">&amp;</font>errmsg<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> SQLITE_OK <font color="#990000">)</font>
            <b><font color="#000000">sqlite3_die</font></b><font color="#990000">(</font>errmsg<font color="#990000">,</font>query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">());</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> count <font color="#990000">&gt;</font> <font color="#993399">0</font> <font color="#990000">)</font>
            <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"You can only have one WSGI file registered, so you must first remove it via -remove (and you can find it via -list)"</font><font color="#990000">);</font>

        <i><font color="#9A1900">// we are not using the app name anymore (see the comments at the</font></i>
        <i><font color="#9A1900">// top of this file), so there is no need anymore to warn about</font></i>
        <i><font color="#9A1900">// using the default app name...</font></i>
        <i><font color="#9A1900">//if ( appname == string(DEFAULT_APP_NAME) )</font></i>
        <i><font color="#9A1900">//cout &lt;&lt; "Using the default app name of '" &lt;&lt; DEFAULT_APP_NAME &lt;&lt; "'" &lt;&lt; endl;</font></i>

        <i><font color="#9A1900">// insert entry into DB</font></i>
        query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
        query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"insert into wsgi values (null,"</font> <font color="#990000">&lt;&lt;</font> uid <font color="#990000">&lt;&lt;</font> <font color="#FF0000">",</font><font color="#CC33CC">\"</font><font color="#FF0000">"</font> <font color="#990000">&lt;&lt;</font> <b><font color="#000000">realpath</font></b><font color="#990000">(</font>wsgi_file_name<font color="#990000">.</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font>NULL<font color="#990000">)</font>
              <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\"</font><font color="#FF0000">,1,datetime(),null,</font><font color="#CC33CC">\"</font><font color="#FF0000">"</font> <font color="#990000">&lt;&lt;</font> appname <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\"</font><font color="#FF0000">,"</font> <font color="#990000">&lt;&lt;</font> reg_root <font color="#990000">&lt;&lt;</font> <font color="#FF0000">",</font><font color="#CC33CC">\"</font><font color="#FF0000">"</font> <font color="#990000">&lt;&lt;</font> staticdir 
	      <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\"</font><font color="#FF0000">,</font><font color="#CC33CC">\"\"</font><font color="#FF0000">,</font><font color="#CC33CC">\"</font><font color="#FF0000">"</font> <font color="#990000">&lt;&lt;</font> morepath <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"</font><font color="#CC33CC">\"</font><font color="#FF0000">)"</font><font color="#990000">;</font>
        ret <font color="#990000">=</font> <b><font color="#000000">sqlite3_exec</font></b><font color="#990000">(</font>db<font color="#990000">,</font> query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font> NULL<font color="#990000">,</font> NULL<font color="#990000">,</font> <font color="#990000">&amp;</font>errmsg<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> SQLITE_OK <font color="#990000">)</font>
            <b><font color="#000000">sqlite3_die</font></b><font color="#990000">(</font>errmsg<font color="#990000">,</font>query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">());</font>

        cout <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"entry registered as /"</font> <font color="#990000">&lt;&lt;</font> <font color="#990000">(</font>reg_root<font color="#990000">?</font><font color="#FF0000">""</font><font color="#990000">:</font><font color="#FF0000">"django/"</font><font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> <b><font color="#000000">get_userid_by_uid</font></b><font color="#990000">(</font>uid<font color="#990000">)</font> <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
    <font color="#FF0000">}</font>

    <i><font color="#9A1900">// list entries in the DB</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> mode <font color="#990000">==</font> MODE_LIST <font color="#990000">)</font> <font color="#FF0000">{</font>
        query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
        query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"select * from wsgi"</font><font color="#990000">;</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!</font>show_all <font color="#990000">)</font>
            query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" where valid=1"</font><font color="#990000">;</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">1000</font><font color="#990000">)</font> <font color="#990000">)</font> <i><font color="#9A1900">// uids 0 and 1000 see all...</font></i>
            query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" and uid="</font> <font color="#990000">&lt;&lt;</font> uid<font color="#990000">;</font>
        ret <font color="#990000">=</font> <b><font color="#000000">sqlite3_exec</font></b><font color="#990000">(</font>db<font color="#990000">,</font> query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font> list_callback<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">&amp;</font>errmsg<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> SQLITE_OK <font color="#990000">)</font>
            <b><font color="#000000">sqlite3_die</font></b><font color="#990000">(</font>errmsg<font color="#990000">,</font>query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">());</font>
    <font color="#FF0000">}</font>

    <i><font color="#9A1900">// remove an entry from the DB</font></i>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> mode <font color="#990000">==</font> MODE_REMOVE <font color="#990000">)</font> <font color="#FF0000">{</font>

        <i><font color="#9A1900">// create query, and pull that data from the DB</font></i>
        query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
        query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"select * from wsgi where id="</font> <font color="#990000">&lt;&lt;</font> remove_id <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" and valid=1"</font><font color="#990000">;</font>
        find_filename <font color="#990000">=</font> <b><font color="#000000">string</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
        ret <font color="#990000">=</font> <b><font color="#000000">sqlite3_exec</font></b><font color="#990000">(</font>db<font color="#990000">,</font> query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font> find_callback<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">&amp;</font>errmsg<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> SQLITE_OK <font color="#990000">)</font>
            <b><font color="#000000">sqlite3_die</font></b><font color="#990000">(</font>errmsg<font color="#990000">,</font>query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">());</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> find_filename <font color="#990000">==</font> <font color="#FF0000">""</font> <font color="#990000">)</font>
            <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"no such entry exists"</font><font color="#990000">);</font>

        <i><font color="#9A1900">// check if UID matches</font></i>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">0</font><font color="#990000">)</font> <font color="#990000">&amp;&amp;</font> <font color="#990000">(</font>uid <font color="#990000">!=</font> <font color="#993399">1000</font><font color="#990000">)</font> <font color="#990000">)</font>
            <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> uid <font color="#990000">!=</font> find_uid <font color="#990000">)</font>
                <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"you can't remove that entry"</font><font color="#990000">);</font>

        <i><font color="#9A1900">// remove entry</font></i>
        query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
        query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"update wsgi set valid=0, removed=datetime() where id="</font> <font color="#990000">&lt;&lt;</font> remove_id<font color="#990000">;</font>
        ret <font color="#990000">=</font> <b><font color="#000000">sqlite3_exec</font></b><font color="#990000">(</font>db<font color="#990000">,</font> query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font> NULL<font color="#990000">,</font> NULL<font color="#990000">,</font> <font color="#990000">&amp;</font>errmsg<font color="#990000">);</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> SQLITE_OK <font color="#990000">)</font>
            <b><font color="#000000">sqlite3_die</font></b><font color="#990000">(</font>errmsg<font color="#990000">,</font>query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">());</font>

        cout <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"entry removed"</font> <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
    <font color="#FF0000">}</font>

    <i><font color="#9A1900">// all of these perform the generation</font></i>
    query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">(</font><font color="#FF0000">""</font><font color="#990000">);</font>
    query <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"select * from wsgi where valid=1"</font><font color="#990000">;</font>
    ret <font color="#990000">=</font> <b><font color="#000000">sqlite3_exec</font></b><font color="#990000">(</font>db<font color="#990000">,</font> query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">(),</font> regenerate_callback<font color="#990000">,</font> <font color="#993399">0</font><font color="#990000">,</font> <font color="#990000">&amp;</font>errmsg<font color="#990000">);</font>
    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> ret <font color="#990000">!=</font> SQLITE_OK <font color="#990000">)</font>
        <b><font color="#000000">sqlite3_die</font></b><font color="#990000">(</font>errmsg<font color="#990000">,</font> query<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">());</font>

    <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> mode <font color="#990000">!=</font> MODE_LIST <font color="#990000">)</font> <font color="#FF0000">{</font>

        <i><font color="#9A1900">// write to django.conf</font></i>
        <font color="#008080">ofstream</font> <b><font color="#000000">fout</font></b><font color="#990000">(</font>DJANGO_CONF_FILE<font color="#990000">);</font>
        fout <font color="#990000">&lt;&lt;</font> wsgifile<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">();</font>
        fout<font color="#990000">.</font><b><font color="#000000">close</font></b><font color="#990000">();</font>
        cout <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"django.conf file regenerated"</font> <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>

        <i><font color="#9A1900">// reload apache</font></i>
        cout <font color="#990000">&lt;&lt;</font> <font color="#FF0000">"reloading the web server..."</font> <font color="#990000">&lt;&lt;</font> endl<font color="#990000">;</font>
        <b><font color="#0000FF">if</font></b> <font color="#990000">(</font> <font color="#990000">!</font><b><font color="#000000">file_exists</font></b><font color="#990000">(</font>APACHE2_RELOAD_CMD<font color="#990000">)</font> <font color="#990000">)</font>
            <b><font color="#000000">die</font></b><font color="#990000">(</font><font color="#FF0000">"unable to find apache2 reload command"</font><font color="#990000">);</font>
        <font color="#008080">stringstream</font> cmd<font color="#990000">;</font>
        cmd <font color="#990000">&lt;&lt;</font> APACHE2_RELOAD_CMD <font color="#990000">&lt;&lt;</font> <font color="#FF0000">" &gt; /dev/null"</font><font color="#990000">;</font>
        <b><font color="#000000">system</font></b><font color="#990000">(</font>cmd<font color="#990000">.</font><b><font color="#000000">str</font></b><font color="#990000">().</font><b><font color="#000000">c_str</font></b><font color="#990000">());</font>
    <font color="#FF0000">}</font>

    <b><font color="#0000FF">return</font></b> <font color="#993399">0</font><font color="#990000">;</font>
<font color="#FF0000">}</font>
</tt></pre>
</body>
</html>
